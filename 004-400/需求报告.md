+-----------------------------------------------------------------------+
| **1 本课题研究的主要内容**                                            |
|                                                                       |
| 本课题研究                                                            |
| 的主要内容是设计和实现基于单片机高精度的接触式扫描透射稿传感器系统。  |
|                                                                       |
| 本系统主要是由STM32F103C8T6主控芯片模块、                             |
| TCD1304传感器采集模块、步进电机驱动模块、人机交互模块、电源模块组成。 |
| 主控器件通过串口连接光源驱动调节灯光亮度。主控连接ULN2003芯片；通过输 |
| 出不同的GPIO状态来驱动步进电机，采用半步驱动的方式让步进电机匀速稳定  |
| 带动透射稿移动，获取稳定光信号。系统利用TCD1304传感器实时采集模拟信号 |
| 并将数据发送给主控芯片，主控芯片通过接收到的数据进行AD转换处理和分析  |
| ，将数据发送给上位机，通过上位机进行显示。同时，系统还配备了OLED显示  |
| 屏和按键以进行人机交互，使得用户可以手动配置控制参数和查看系统状态。  |
|                                                                       |
| ![硬件框图](media/image1.png){width="4.842361111111111in"             |
| height="3.70625in"}                                                   |
|                                                                       |
| 图1 硬件组成框图                                                      |
|                                                                       |
| **2 设计（论文）进展情况**                                            |
|                                                                       |
| **2.1信息采集与处理模块**                                             |
|                                                                       |
| **2.1.1TCD1304时序逻辑电路的分析**                                    |
|                                                                       |
| TCD1304是一款由东芝公司生产的线性光电传感器。它的主要功能             |
| 是将通过它的光转换为电信号，常用于需要光传感的应用。并将这些信号传递  |
| 给处理电路进行处理。它的输出是模拟信号，需要通过模拟-数字转换（ADC）  |
| 处理后得到数字数据。如图1所示是TCD1304的整体时序要求。从图中可以看出  |
| ，SH脉冲用于控制积分时间，相邻SH脉冲下降沿之间的间隔就是积分时间。ICG |
| 负脉冲则控制开始 clock out 模拟输出的时间;在idle状态下，ICG           |
| 为高电                                                                |
| 位，负脉冲发生时ICG电位被拉低。ϕM为时钟输入信号，OS为模拟输出端，ICG  |
| 负脉冲结束后，OS开始依次输出各个像素上的值。比较ϕM的时序              |
| 和OS的时序，可以看到每4个时钟周期OS输出一个像素上的值，即对于TCD1304  |
| 来说完成一次像素间的电荷转移需要的时间可以看作 4                      |
| 个时钟周期,但是实际上这只是一种等效的说法。                           |
|                                                                       |
| ![TCD1304DG驱动示意图](media/image2.jpeg){width="5.449305555555555in" |
| height="2.7055555555555557in"}                                        |
|                                                                       |
| 图2 TCD1304输出信号                                                   |
|                                                                       |
| 由图一可以了解到，TCD1304扫描得到的3694个信号中，前32个为             |
| 无效信号，其中3648为有效信号，是要采集输出转换为电信号的，后14个也为  |
| 无效信号，在程序实现中，只需要实现扫描所有信号，再输出有效信号即可。  |
|                                                                       |
| 具体的时序要求如图2所示从表中我们知道如下的要求：                     |
|                                                                       |
| 在初始状态，ICG引脚为高电位，SH引脚为低电位，时钟信号正常工作。       |
|                                                                       |
| CCD的一个工作周期从ICG负脉冲的下降沿开始。                            |
|                                                                       |
| ICG负脉冲下降沿后推迟500ns为SH脉冲的上升沿。                          |
|                                                                       |
| SH 脉冲至少持续 1000ns。                                              |
|                                                                       |
| SH 脉冲结束后，ICG负脉冲再推迟5000ns后结束。                          |
|                                                                       |
| ICG 负脉冲结束时，时钟信号必须为高电位。                              |
|                                                                       |
| 根据图1和图2的得到的关                                                |
| 于TCD1304的时序逻辑和信号。可以将TCD1304的时序逻辑图编写成程序如下：  |
|                                                                       |
| ![CCD代码1](media/image3.jpeg){width="5.054166666666666in"            |
| height="7.2034722222222225in"}                                        |
|                                                                       |
| 图3 TCD1304时序程序                                                   |
|                                                                       |
| 手动延时的精度受                                                      |
| CPU主频和编译器优化影响，在后期进行综合硬件上测试时改为通过硬件定时器 |
| TIM生成三个信号，确保了信号的频率和占空比符合TCD1304的要求。          |
|                                                                       |
| **2.1.2ADC采集数据结合DMA转移**                                       |
|                                                                       |
| TCD1304所要采集的有效信有3648个，每个像素的模拟信号需要               |
| 在短时间内完成采集。如果使用传统的CPU轮询方式读取ADC数据，会占用大量  |
| CPU                                                                   |
| 资源，且无法满足高速采集的需求。且TCD1304传感                         |
| 器的数据采集需要严格的时序控制，任何延迟都可能导致数据错误或丢失。在  |
| TCD1304 的数据采集中，DMA 可以连续地将 ADC                            |
| 转换结果存储到指定的内存区域（如数组 ADC_Buffer），避免了 CPU         |
| 的频繁干预。DMA                                                       |
| 自动将                                                                |
| 数据传输到内存缓冲区中，实现了高效、实时的数据采集。代码如下图所示；  |
|                                                                       |
| ![ADC代码1](media/image4.png){width="4.350694444444445in"             |
| height="4.034027777777778in"}                                         |
|                                                                       |
| 图4 ADC采集程序                                                       |
|                                                                       |
| **2.1.3 USART通信**                                                   |
|                                                                       |
| USART通信通常有两种                                                   |
| 工作模式：异步模式和同步模式。在异步模式下，通信双方的时钟信号不需要  |
| 同步，而是通过预先设定的波特率（如9600、115200等）来控制数据传输的速  |
| 率。同步模式下，数据传输需要同步时钟信号来同步发送和接收。USART通信在 |
| 处理速度和灵活性上具有明显的优势，特别是在全双工通信、高波特率和高数  |
| 据吞吐量方面。在本系统中使用USART和指针进行数据传送。指针使得访问和操 |
| 作内存更加灵活。在USART_SendDataBuffer中，通过指针p访问和发送数据的高 |
| 字节和低字节；在USART_ReceiveDataBuffer中，通过指针p接收字节并存储到  |
| 缓冲区。指针避免了数组下标带来的额外计算，提高了代码效率。代码如下：  |
|                                                                       |
| ![USART](media/image5.png){width="4.004166666666666in"                |
| height="3.276388888888889in"}                                         |
|                                                                       |
| 图5 USART通信程序                                                     |
|                                                                       |
| **2.1.2TCD1304信号采集部分的示波器测试**                              |
|                                                                       |
| 将STM32板子与CCD连接在一起，如下图所示，供电由一个USB充电器支持。     |
|                                                                       |
| ![STMccd](media/image6.png){width="3.1375in"                          |
| height="1.8534722222222222in"}                                        |
|                                                                       |
| 图6 实物连接图                                                        |
|                                                                       |
| 利用示波器进行了检测，即可看到由于CCD积分溢出来形成的信号，使         |
| 用情况如图6所示，由于将CCD的左侧用黑色胶带封住，可以看到形成的信号也  |
| 对应胶带的位置，左侧为较弱信号，而右侧由于光照充足信号溢出达到饱满。  |
|                                                                       |
| ![示波器1](media/image7.jpeg){width="3.229861111111111in"             |
| height="1.9375in"}                                                    |
|                                                                       |
| 图7 CCD积分图像                                                       |
|                                                                       |
| 此时，将 CCD 放入无光照的环境中，取下黑胶带，拿一些光斑去照射 CCD     |
| 上的感光区，就可以在示波器上                                          |
| 看到正常工作的信号了，如图所示是一个被用3根导线随机挡了一下的光源，可 |
| 以看到三根导线的影子区域光强比较低，反映为信号当中的几个高电位峰值。  |
|                                                                       |
| ![示波器2](media/image8.jpeg){width="3.8194444444444446in"            |
| height="2.303472222222222in"}                                         |
|                                                                       |
| 图8 CCD工作信号图                                                     |
|                                                                       |
| 将 ICG和SH引脚的信号也一同引入示波器中，如图6所示，Channel1为SH       |
| 脉冲，Channel 2为 ICG                                                 |
| 脉冲，Channel3则是OS的输出。在ICG脉冲结束                             |
| 后几十微秒后，捕捉到了OS的输出信号。测量OS输出信号的总时长，刚好为7.3 |
| ms，设置的时钟频率为2MHz，因此，按照之前的计算，OS的数据率为          |
| 0.                                                                    |
| 5MHz，即每2μs输出一个像素上的值，TCD1304共3648个像素，总共就需要7.296 |
| ms输出完毕，这与实验的结果非常吻合。同时发现，在图中我们可以看到脉冲  |
| 的各沿有一些抖动，这是由于我们使用屏蔽很差的杜邦线作为信号连接线，线  |
| 间发生电磁感应导致的，这会使我们的噪声非常大，因此，调试时使用的杜邦  |
| 线不宜过长。这些噪音在最后将各个元件焊接到电路版上之后可以改善很多。  |
|                                                                       |
| ![示波器3](media/image9.jpeg){width="3.870833333333333in"             |
| height="2.297222222222222in"}                                         |
|                                                                       |
| 图9 CCD各个信号时序图                                                 |
|                                                                       |
| 在运行程序后进行简单的程序测试得到如下的结果，与                      |
| 示波器上波形几乎一致，但是存在较大的噪声问题，是后期重点解决的问题。  |
|                                                                       |
| ![运行图](media/image10.png){width="4.104166666666667in"              |
| height="2.292361111111111in"}                                         |
|                                                                       |
| 图10 CCD程序运行图                                                    |
|                                                                       |
| **2.2步进电机驱动模块**                                               |
|                                                                       |
| **2.2.1控制步进电机稳定移动**                                         |
|                                                                       |
| 步进电机两种常                                                        |
| 见的驱动方式为全步驱动和半步驱动，其中全步驱动步进角度°者大如1.8°用于 |
| 对转动速度要求高但是精度要求不高的场景，半步驱动的步进角度较小如0.9°  |
| 适用于精要求较高，适用于运行平缓的场景，转速相对较慢。半步驱动使用8拍 |
| 的相位表，实现步进电机的半步驱动，每个拍对应步进电机的一个状态。使用  |
| TIM3 定时器中断来控制步进频率，避免占用 CPU 资源。通过                |
| Motor_direction 变量控制步进电机的转动方向。使用 GPIO 直接控制        |
| ULN2003 的输入端，简化硬件设计。实现代码如下；                        |
|                                                                       |
| ![uln3](media/image11.jpeg){width="3.2284722222222224in"              |
| height="3.5833333333333335in"}                                        |
|                                                                       |
| 图11 ULN2003驱动程序图                                                |
|                                                                       |
| **2.3光源驱动和调节模块**                                             |
|                                                                       |
| DCS2.0-2C030W-24PS 光源控制器其主要功能是通过 RS232                   |
| 串口通信                                                              |
| 与上位机进行交互，实现对光源亮度的精确控制和调节。在本系统中使用通过  |
| MAX3232 芯片将 STM32 的 USART 电平转换为 RS232                        |
| 电平，实现与计算机的通信。                                            |
|                                                                       |
| **2.3.1通信协议**                                                     |
|                                                                       |
|   ---------------- ---------------- ---------------- ---------------- |
|   波特率           数据长度         停止位           奇偶校验         |
|                                                                       |
|   9600bps          8bits            1bit             无               |
|   ---------------- ---------------- ---------------- ---------------- |
|                                                                       |
| 表1 硬件规范                                                          |
|                                                                       |
|   -                                                                   |
| ------------ ------------- ------------- ------------- -------------- |
|   1字节         1字节         1字节         3字节         2字节       |
|                                                                       |
|                                                                       |
|  特征字        命令字        通道字        数据          异或和校验字 |
|   -                                                                   |
| ------------ ------------- ------------- ------------- -------------- |
|                                                                       |
| 表2 数据格式                                                          |
|                                                                       |
| **2.4 硬件设计**                                                      |
|                                                                       |
| **PCB原理图绘制**                                                     |
|                                                                       |
| 本系统基于 STM32F103C8T6 主控芯片，集成了多个功能模块，包括TCD1304    |
| 传感器                                                                |
| 采集模块、步进电机驱动模块、人机交互模块和电源模块。系统原理图如下：  |
|                                                                       |
| ![第一版原理图](media/image12.png){width="5.651388888888889in"        |
| height="3.8520833333333333in"}                                        |
|                                                                       |
| 图12 PCB原理图                                                        |
|                                                                       |
| **2.4.1对主控系统原理图的绘制**                                       |
|                                                                       |
| ![PCBSTM32核心模块](media/image13.png){width="5.1722222222222225in"   |
| height="1.8743055555555554in"}                                        |
|                                                                       |
| 图13 主控最小系统原理图                                               |
|                                                                       |
| **2.4.2 CCD线阵扫描电路模块**                                         |
|                                                                       |
| 采用TCD1304扫描传感器实现信号                                         |
| 扫描得到光信号，从芯片手册中得出，CCD所需要的驱动脉冲高电平电压约为5  |
| V,STM32产生的驱动CCD工作的脉冲信号的电压为3.3                         |
| V，在脉冲进入到CCD引脚之前，要将                                      |
| 电平进行转换，采用型号为74HC04的反相器来解决两者之间电平转换的问题。  |
|                                                                       |
| ![PCB TCD1304模块](media/image14.png){width="3.4472222222222224in"    |
| height="2.0881944444444445in"}                                        |
|                                                                       |
| 图14 线阵扫描电路                                                     |
|                                                                       |
| **2.4.3运算放大电路**                                                 |
|                                                                       |
| TCD1304在接受到光源照射后理论输                                       |
| 出电压范围是1.5-3.5V，而本系统使用的STM32微控制器的基准电压为0-3.3V。 |
| 并不适配STM32的ADC输入范围造成信号的丢失，为了解决这个问题使用了两个  |
| TLV6001IDBVR                                                          |
| 运                                                                    |
| 算放大器，分别进行电压降低和电压放大；电压降低电路将1.5V到3.5V降低到  |
| 0V 到                                                                 |
| 2V;使用减法电路,减去一个基准电压V~ref~,将                             |
| 输入信号的直流分量降低。放大倍数设置为1，仅进行电压平移。下面是计算； |
|                                                                       |
| $$Vref = \frac{R27}{R27 + R28} \times Vsupply$$                       |
|                                                                       |
| 将已知值带入其中可以得到：                                            |
|                                                                       |
| $$Vref = \frac{1.5k}{1.5k + 3.5k} \times 5V$$                         |
|                                                                       |
| 解得V~ref~=1.5V                                                       |
|                                                                       |
| 对于输入电压1.5V:$Vout = 1.5V - 1.5V = 0V$                            |
|                                                                       |
| 对于输入电压3.5V:$Vout = 3.5V - 1.5V = 2V$                            |
|                                                                       |
| 因此减法器的输出电压范围为0V到2V                                      |
|                                                                       |
| 电压放大电路将0V到2V                                                  |
| 放大到0V到3.3V。继续使用TLV6001IDBVR搭建同相放大电路。                |
|                                                                       |
| 同相放大电路的放大倍数公式为：                                        |
|                                                                       |
| $$A = 1 + \frac{Rf}{Rin}$$                                            |
|                                                                       |
| 将已知值带入其中可以得到：                                            |
|                                                                       |
| $$A = 1 + \frac{6.5k}{10k}$$                                          |
|                                                                       |
| 解得A=1.65                                                            |
|                                                                       |
| 对于输入电压0V:                                                       |
|                                                                       |
| $$Vout = 0 \times A = 0V$$                                            |
|                                                                       |
| 对于输入电压2V:                                                       |
|                                                                       |
| $$Vout = 2 \times 1.65 = 3.3V$$                                       |
|                                                                       |
| 所以最终输出的电压范围为0\~3.3V                                       |
| ，TCD1304的输出电压可以完整进入STM32F103芯片中符合ADC的信号采集范围。 |
|                                                                       |
| ![PCB运放电路模块](media/image15.png){width="4.065277777777778in"     |
| height="1.9458333333333333in"}                                        |
|                                                                       |
| 图15 运算放大电路                                                     |
|                                                                       |
| **2.4.4 ULN2003步进电机模块**                                         |
|                                                                       |
| 使用STM32F103系列微控制器控制ULN2003驱动步进电机，驱动滑台实现平稳    |
| 移动。滑台将携带透射稿件，并由CCD传感器进行扫描，从而获取精确的数据。 |
|                                                                       |
| ![PCB步进电机模块](media/image16.png){width="4.1097222222222225in"    |
| height="1.8993055555555556in"}                                        |
|                                                                       |
| 图16 步进电机电路                                                     |
|                                                                       |
| **2.4.5人机交互模块**                                                 |
|                                                                       |
| IPSLCD1LED 液晶显示屏：显示系统的工作状态。                           |
|                                                                       |
| TS-1101-C-W 按键：用于参数配置和功能选择。                            |
|                                                                       |
| ![PCB人机交互界面](media/image17.png){width="2.7909722222222224in"    |
| height="3.2868055555555555in"}                                        |
|                                                                       |
| 图17 人机交互电路                                                     |
|                                                                       |
| **2.4.6电源模块**                                                     |
|                                                                       |
| AMS1117-3.3V：为 STM32 和 TCD1304 提供 3.3V 电源。                    |
|                                                                       |
| LM2575S-5.0：为 OLED 显示屏和步进电机驱动模块提供 5V 电源。           |
|                                                                       |
| DC-005-A200：总电源输入模块，提供 12V 或 5V 电源。                    |
|                                                                       |
| ![PCB电源模块](media/image18.png){width="2.9895833333333335in"        |
| height="2.3430555555555554in"}                                        |
|                                                                       |
| 图18 电源电路模块                                                     |
|                                                                       |
| **2.5整体工作进度**                                                   |
|                                                                       |
| 已成功实现了TCD1304传感器的信号采集功能，并进                         |
| 行了相关的信号测试。传感器能够按照预定的时序生成控制信号，完成图像数  |
| 据的采集，为后续的信号处理和分析提供了可靠的数据来源。已经实现了步进  |
| 电机的驱动功能，通过控制电机的转向和步进，实现了导轨的较为平稳移动。  |
|                                                                       |
| ![总图](media/image19.jpeg){width="3.3833333333333333in"              |
| height="2.5347222222222223in"}                                        |
|                                                                       |
| **3 存在的问题及拟采用的解决方案**                                    |
|                                                                       |
| 1.信号干扰问题：当前系统在高频信号处理时可能出现                      |
| 一定的噪声，存在部分原因为连接导致数据的不稳定性。以提高信号的稳定性  |
| 和精确度。由于我们使用屏蔽很差的杜邦线作为信号连接线，线间发生电磁感  |
| 应导致的，这会使我们的噪声非常大，因此，调试时使用的杜邦线不宜过长。  |
|                                                                       |
| 这些噪音在最后将各个元件焊接到电路版上之后可以改善很多                |
|                                                                       |
| 2.步进                                                                |
| 电机控制精度问题：虽然步进电机已经能够稳定运转，但在高精度控制要求下  |
| ，步进电机的误差仍然较大。计划进一步优化信号的频率及精度，减小误差。  |
|                                                                       |
| **4 后期工作安排**                                                    |
|                                                                       |
| **3. 下一步工作计划**                                                 |
|                                                                       |
| 1.完善数据采集：优化TCD1304的数据                                     |
| 采集程序，优化程序更好的采集专业数据，进一步使用USB接口帮助上传数据。 |
|                                                                       |
| 2.优                                                                  |
| 化步进电机控制算法，提高运动精度，减少系统误差，让导轨运行更加平稳。  |
|                                                                       |
| 3.进一步出设计人机交互界面，可以根据透射稿底片的                      |
| 亮度，调节灯光强度帮助更好的得到更加准确的数据在屏幕显示出工作状态。  |
|                                                                       |
| 4.进行系统整合与调试，确保系统能够稳定运行，满足设计要求。            |
|                                                                       |
| 5.编写论文，准备终期相应工作。                                        |
+-----------------------------------------------------------------------+
| \`                                                                    |
+-----------------------------------------------------------------------+
